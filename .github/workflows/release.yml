name: "Create release"

env:
  WASI_SDK_PATH: /opt/wasi-sdk

on:
    workflow_dispatch:
        inputs:
            python_version:
                required: true
                description: "Version of CPython to build"
            wasi_sdk_version:
                required: true
                default: 19
                type: number
                description: "WASI-SDK version"

jobs:
    build:
        name: "Build CPython ${{ inputs.python_version }}"
        runs-on: ubuntu-latest
        steps:
          - name: "Install WASI-SDK ${{ inputs.wasi_sdk_version }}"
            run: |
              mkdir ${{ env.WASI_SDK_PATH }} && \
              curl -s -S --location https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-${{ inputs.wasi_sdk_version }}/wasi-sdk-${{ inputs.wasi_sdk_version }}.0-linux.tar.gz | \
              tar --strip-components 1 --directory ${{ env.WASI_SDK_PATH }} --extract --gunzip
              $WASI_SDK_PATH/bin/clang --version
          - name: "Install wasmtime"
            run: |
              curl https://wasmtime.dev/install.sh -sSf | bash
              mkdir --parents $HOME/.local/bin
              ln -s $HOME/.wasmtime/bin/wasmtime $HOME/.local/bin/
              wasmtime --version
          - name: "Install build dependencies"
            # https://devguide.python.org/getting-started/setup-building/#linux
            # Removed: gdb lcov libffi-dev libncurses5-dev libreadline6-dev tk-dev
            run: |
              sudo apt-get install build-essential pkg-config \
              libbz2-dev libgdbm-dev libgdbm-compat-dev liblzma-dev \
              libsqlite3-dev libssl-dev \
              lzma lzma-dev uuid-dev zlib1g-dev
          - name: "Install Python"
            uses: actions/setup-python@v4
            with:
              python-version: "3.x"
          - name: "Checkout CPython"
            uses: actions/checkout@v3
            with:
              repository: "python/cpython"
              ref: "v${{ inputs.python_version }}"
          - name: "Build"
            run: python3 Tools/wasm/wasm_build.py wasi build

